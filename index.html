<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>منظم طلبات التوصيل</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
  <!-- SortableJS للترتيب بالسحب -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- SheetJS لاستخراج Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- JsBarcode لرموز الباركود -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <!-- QRCode.js لإنشاء رمز QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
  <style>
    body { background: #f0f8ff; font-family: sans-serif; }
    .header { text-align: center; margin: 20px; position: relative; }
    .controls .form-control, .controls .btn { margin: 5px; }
    .order-grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
    .order-card { border-radius: .5rem; border: 1px solid #dee2e6; background: #fff; padding: 15px; position: relative; }
    .order-card.cod { border-color: #ffc107; background: #fff8e1; }
    .card-border { position: absolute; top: 0; right: 0; width: 5px; height: 100%; background: #5a35ff; border-bottom-right-radius: .5rem; border-top-right-radius: .5rem; }
    .order-number { position: absolute; top: 10px; left: 10px; background: #f8f9fa; color: #343a40; padding: 2px 8px; border-radius: .25rem; font-size: .9rem; }
    /* قالب البوليصة */
    .label { width: 300px; border: 1px solid #000; padding: 10px; margin: 5px; display: inline-block; font-size: 14px; direction: rtl; text-align: right; }
    .label-logo { display: block; margin: 0 auto 10px; max-width: 100px; }
    .label .header { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .label .cod-box { font-weight: bold; }
    .label .amount-box { background: #000; color: #fff; padding: 5px; }
    .label .barcode, .label .qrcode { display: block; margin: 5px auto; }
  </style>
</head>

<body>

  <div class="header">
    <h1>منظم طلبات التوصيل</h1>
    <!-- ماسح الباركود -->
    <input id="scanner" class="form-control scanner-input" placeholder="امسح رقم الطلب هنا" autofocus/>
    <div class="controls row justify-content-center">
      <!-- استيراد ملف -->
      <div class="col-auto">
        <input type="file" id="fileInput" accept=".xlsx,.csv" class="form-control"/>
      </div>
      <!-- بحث -->
      <div class="col-auto">
        <input id="searchInput" class="form-control" placeholder="ابحث برقم الطلب أو اسم العميل"/>
      </div>
      <!-- فلاتر الحالة -->
      <div class="col-auto">
        <button class="btn btn-outline-secondary filter-btn" data-status="">الكل</button>
        <button class="btn btn-outline-info filter-btn" data-status="pending">قيد الانتظار</button>
        <button class="btn btn-outline-warning filter-btn" data-status="in_transit">جاري التوصيل</button>
        <button class="btn btn-outline-success filter-btn" data-status="delivered">تم التوصيل</button>
        <button class="btn btn-outline-primary filter-btn" data-status="cod">دفع عند الاستلام</button>
        <button class="btn btn-outline-danger filter-btn" data-status="rejected">مرفوض</button>
      </div>
      <!-- أزرار -->
      <div class="col-auto">
        <button id="enableManual" class="btn btn-info">تمكين الترتيب اليدوي</button>
        <button id="applyNumbers" class="btn btn-primary">تطبيق الترقيم</button>
        <button id="selectAll" class="btn btn-secondary">تحديد الكل</button>
        <button id="printSelected" class="btn btn-success"><i class="bi bi-printer"></i> طباعة بوليصات مختارة</button>
      </div>
    </div>
  </div>

  <!-- شبكة البطاقات -->
  <div id="orderGrid" class="container order-grid"></div>

  <!-- قالب البطاقة -->
  <template id="orderCardTemplate">
    <div class="order-card">
      <div class="card-border"></div>
      <span class="order-number"></span>
      <h5 class="customer-name"></h5>
      <p class="customer-address"><i class="bi bi-geo-alt"></i> <span></span></p>
      <p><i class="bi bi-telephone"></i> <span class="phone"></span></p>
      <p><i class="bi bi-box-seam"></i> <span class="items-count"></span> منتجات</p>
      <p><i class="bi bi-clock"></i> <span class="time-range"></span></p>
      <div class="d-flex justify-content-between">
        <!-- طباعة بوليصة فردية -->
        <button class="btn btn-outline-secondary btn-print-single"><i class="bi bi-printer"></i></button>
        <!-- واتساب شحن -->
        <button class="btn btn-success btn-wa-shipping"><i class="bi bi-whatsapp"></i></button>
        <!-- واتساب وصول -->
        <button class="btn btn-success btn-wa-arrival"><i class="bi bi-whatsapp"></i></button>
        <!-- اتصال -->
        <button class="btn btn-primary btn-call"><i class="bi bi-telephone"></i></button>
      </div>
      <!-- الدفع عند الاستلام يميّز البطاقة -->
      <span class="cod-marker badge bg-warning">دفع عند الاستلام</span>
      <!-- اختيار لطباعة جماعية -->
      <input type="checkbox" class="form-check-input select-for-label" style="position:absolute;top:10px;left:10px;"/>
      <!-- حالة الطلب -->
      <select class="form-select status-select mt-2">
        <option value="pending">قيد الانتظار</option>
        <option value="in_transit">جاري التوصيل</option>
        <option value="delivered">تم التوصيل</option>
        <option value="cod">دفع عند الاستلام</option>
        <option value="rejected">مرفوض</option>
      </select>
    </div>
  </template>

  <!-- قالب البوليصة للطباعة -->
  <template id="labelTemplate">
    <div class="label">
      <!-- شعار واحة التقنية ضمن Base64 -->
      <img class="label-logo"
           src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAyAAAAEsCAYAAAA7Ldc6AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAFLWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSfvu78nIGlkPSdXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQnPz4KPHg6eG1wbWV0YSB4bWxuczp4PSdhZG9iZTpuczptZXRhLyc+CjxyZGY6UkRGIHhtbG5zOnJkZj0naHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyc+CgogPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9JycKICB4bWxuczpBdHRyaWI9J2h0dHA6Ly9ucy5hdHRyaWJ1dGlvbi5jb20vYWRzLzEuMC8nPgogIDxBdHRyaWI6QWRzPgogICA8cmRmOlNlcT4KICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0nUmVzb3VyY2UnPgogICAgIDxBdHRyaWI6Q3JlYXRlZD4yMDI1LTA2LTEyPC9BdHRyaWI6Q3JlYXRlZD4KICAgICA8QXR0cmliOkV4dElkPjI0MzMyMzIxLTcxMzktNDJjMi1iNjlmLTFiMjFhMjQyYzQ4YjwvQXR0cmliOkV4dElkPgogICAgIDxBdHRyaWI6RmJJZD41MjUyNjU5MTQxNzk1ODA8L0F0dHJpYjpGYklkPgogICAgIDxBdHRyaWI6VG91Y2hUeXBlPjI8L0F0dHJpYjpUb3VjaFR5cGU+CiAgICA8L3JkZjpsaT4KICAgPC9yZGY6U2VxPgogIDwvQXR0cmliOkFkcz4KIDwvcmRmOkRlc2NyaXB0aW9uPgoKIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PScnCiAgeG1sbnM6ZGM9J2h0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvJz4KICA8ZGM6dGl0bGU+CiAgIDxyZGY6QWx0PgogICAgPHJkZjpsaSB4bWw6bGFuZz0neC1kZWZhdWx0Jz7ZiNin2K3YqSDYp9mE2KrZgtmG2YrYqSAoMTAwMCB4IDUwMCDYqNmK2YPYs9mEKSAoMTAwMCB4IDUwMCDYqNmK2YPYs9mEKSAoODAwIHggMzUwINio2YrZg9iz2YQpICg4MDAgeCAzMDAg2KjZitmD2LPZhCkgLSAxPC9yZGY6bGk+CiAgIDwvcmRmOkFsdD4KICA8L2RjOnRpdGxlPgogPC9yZGY6RGVzY3JpcHRpb24+CgogPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9JycKICB4bWxuczpwZGY9J2h0dHA6Ly9ucy5hZG9iZS5jb20vcGRmLzEuMy8nPgogIDxwZGY6QXV0aG9yPtin2KjYsdin2YfZitmFINi52YrYrzwvcGRmOkF1dGhvcj4KIDwvcmRmOkRlc2NyaXB0aW9uPgoKPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9JycKICB4bWxuczp4bXBjb25...
      " alt="شعار واحة التقنية">
      <div class="header">
        <div class="cod-box">الدفع عند الاستلام</div>
        <div class="amount-box">0</div>
      </div>
      <h1 class="order-number">#123456</h1>
      <p class="customer-name">اسم العميل</p>
      <p class="customer-address">عنوان العميل</p>
      <!-- الباركود -->
      <svg class="barcode"
           jsbarcode-format="CODE128"
           jsbarcode-value="123456"
           jsbarcode-textmargin="0"
           jsbarcode-fontSize="12"
           jsbarcode-height="40"
           jsbarcode-width="2"></svg>
      <!-- الـ QR -->
      <canvas class="qrcode"></canvas>
    </div>
  </template>

  <!-- الصوت -->
  <audio id="audioSuccess" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="audioError"   src="https://actions.google.com/sounds/v1/cartoon/boing.ogg"></audio>

  <!-- Bootstrap & JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // العناصر
    const fileInput      = document.getElementById('fileInput');
    const orderGrid      = document.getElementById('orderGrid');
    const cardTpl        = document.getElementById('orderCardTemplate');
    const labelTpl       = document.getElementById('labelTemplate');
    const searchInput    = document.getElementById('searchInput');
    const filterBtns     = document.querySelectorAll('.filter-btn');
    const scannerInput   = document.getElementById('scanner');
    const audioSuccess   = document.getElementById('audioSuccess');
    const audioError     = document.getElementById('audioError');
    const enableManual   = document.getElementById('enableManual');
    const applyNumbers   = document.getElementById('applyNumbers');
    const selectAllBtn   = document.getElementById('selectAll');
    const printSelBtn    = document.getElementById('printSelected');

    let orders = [], dragger;

    // استيراد Excel/CSV
    fileInput.addEventListener('change', e=>{
      if(!e.target.files.length) return;
      const f = e.target.files[0];
      const reader = new FileReader();
      reader.onload = evt=>{
        const data = evt.target.result;
        const wb = XLSX.read(data, {type:'binary'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const js = XLSX.utils.sheet_to_json(sheet);
        orders = js.map((r,i)=>({
          idx:i+1,
          orderId:r['رقم الطلب']||r['Order ID']||'',
          customerName:r['اسم العميل']||r['Customer']||'',
          address:r['العنوان']||r['Address']||'',
          phone:r['الهاتف']||r['Phone']||'',
          itemsCount:r['عدد المنتجات']||r['Items']||0,
          timeRange:r['الوقت']||r['Time']||'',
          status:'pending',
          codPayment:(r['طريقة الدفع']||'').includes('استلام')
        }));
        render();
        enableDrag();
      };
      reader.readAsBinaryString(f);
    });

    // عرض البطاقات
    function render(){
      orderGrid.innerHTML='';
      orders.forEach(o=>{
        const tpl = cardTpl.content.cloneNode(true);
        const card = tpl.querySelector('.order-card');
        tpl.querySelector('.order-number').textContent = o.idx;
        tpl.querySelector('.customer-name').textContent = o.customerName;
        tpl.querySelector('.customer-address span').textContent = o.address;
        tpl.querySelector('.phone').textContent = o.phone;
        tpl.querySelector('.items-count').textContent = o.itemsCount;
        tpl.querySelector('.time-range').textContent = o.timeRange;
        // COD؟
        if(o.codPayment) card.classList.add('cod');
        // الواتساب – شحن
        tpl.querySelector('.btn-wa-shipping').onclick = ()=>{
          const msg = `السلام عليكم\nأنا مندوب واحة التقنية\nلديك طلبية جاهزة للتوصيل\nأرسل الموقع 📍\nورقم المنزل🏚\nوسيتم التواصل معك قبل التوصيل⏳🚗`;
          window.open(`https://wa.me/${o.phone}?text=${encodeURIComponent(msg)}`, '_blank');
        };
        // الواتساب – وصول
        tpl.querySelector('.btn-wa-arrival').onclick = ()=>{
          const msg = `دقيقة تقريبا وبكون في الموقع ان شاءالله\nمناسب؟؟`;
          window.open(`https://wa.me/${o.phone}?text=${encodeURIComponent(msg)}`, '_blank');
        };
        // اتصال
        tpl.querySelector('.btn-call').onclick = ()=> location.href = `tel:${o.phone}`;
        // تغيير الحالة
        tpl.querySelector('.status-select').value = o.status;
        tpl.querySelector('.status-select').onchange = e=>{
          o.status = e.target.value;
          card.gridRowStart = ''; // لفرز مجدداً
        };
        // طباعة فردية
        tpl.querySelector('.btn-print-single').onclick = ()=>{
          printLabels([o]);
        };
        // الاختيار الجماعي
        tpl.querySelector('.select-for-label').onchange = ()=>{};
        orderGrid.append(tpl);
      });
    }

    // تفعيل السحب والإفلات
    function enableDrag(){
      if(dragger) dragger.destroy();
      dragger = Sortable.create(orderGrid, {
        handle: '.order-card',
        animation: 150,
        onEnd: e=>{
          const moved = orders.splice(e.oldIndex,1)[0];
          orders.splice(e.newIndex,0,moved);
          orders.forEach((o,i)=>o.idx=i+1);
          render();
        }
      });
    }

    // ترقيم يدوي
    applyNumbers.onclick = ()=>{
      document.querySelectorAll('.order-card').forEach((card,i)=>{
        const num = card.querySelector('input[type=number]')?.value || i+1;
        orders[i].idx = +num;
      });
      orders.sort((a,b)=>a.idx-b.idx);
      render();
    };

    // بحث
    searchInput.oninput = ()=>{
      const q = searchInput.value.trim();
      document.querySelectorAll('.order-card').forEach((card,i)=>{
        const o = orders[i];
        const match = !q || o.orderId.includes(q) || o.customerName.includes(q);
        card.style.display = match? '' : 'none';
      });
    };

    // فلترة حسب الحالة
    filterBtns.forEach(btn=>{
      btn.onclick = ()=>{
        filterBtns.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const st = btn.dataset.status;
        document.querySelectorAll('.order-card').forEach((card,i)=>{
          const o = orders[i];
          card.style.display = (st===''||o.status===st)? '' : 'none';
        });
      };
    });

    // مسح الباركود
    scannerInput.onkeypress = e=>{
      if(e.key!=='Enter') return;
      const code = scannerInput.value.trim();
      const idx = orders.findIndex(o=>o.orderId===code);
      if(idx>=0){
        orders[idx].status = 'in_transit';
        audioSuccess.play();
        render();
      } else {
        audioError.play();
      }
      scannerInput.value='';
    };

    // تحديد الكل
    selectAllBtn.onclick = ()=>{
      const boxes = document.querySelectorAll('.select-for-label');
      const all = [...boxes].every(b=>b.checked);
      boxes.forEach(b=>b.checked=!all);
    };

    // طباعة بوليصات مختارة
    printSelBtn.onclick = ()=>{
      const selected = [...document.querySelectorAll('.select-for-label')]
        .map((b,i)=>b.checked? orders[i]: null)
        .filter(x=>x);
      if(selected.length) printLabels(selected);
    };

    // طباعة بوليصات
    function printLabels(list){
      const w = window.open('', '_blank');
      w.document.write('<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/><title>بوليصات شحن</title>');
      w.document.write('<style>body{font-family:sans-serif;direction:rtl} .label{display:inline-block;margin:5px;} </style></head><body>');
      list.forEach(o=>{
        const tpl = labelTpl.content.cloneNode(true);
        tpl.querySelector('.order-number').textContent = '#'+o.orderId;
        tpl.querySelector('.customer-name').textContent = o.customerName;
        tpl.querySelector('.customer-address').textContent = o.address;
        tpl.querySelector('.amount-box').textContent = o.codPayment? o.itemsCount : 0;
        // توليد الباركود
        const svg = tpl.querySelector('.barcode');
        svg.setAttribute('jsbarcode-value', o.orderId);
        JsBarcode(svg).init();
        // توليد QR
        const canvas = tpl.querySelector('.qrcode');
        QRCode.toCanvas(canvas, o.orderId, { width: 80 });
        w.document.body.appendChild(tpl);
      });
      w.document.close();
      w.print();
    }
  </script>
</body>
</html>

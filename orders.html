<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ù†Ø¸Ù… Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</title>
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <style>
    body { background: #f0f8ff; font-family: sans-serif; }
    .header { text-align: center; margin: 20px 0; position: relative; }
    .scanner-input { margin: 10px auto; width: 300px; display: block; opacity: 0.7; }
    .controls .form-control, .controls .btn { margin: 5px; }
    .status-filters { text-align: center; margin-bottom: 15px; }
    .status-filters .btn { margin: 0 5px; min-width: 100px; }
    .status-filters .active { box-shadow: inset 0 0 5px #00000033; }
    .order-card { border-radius: .5rem; border: 1px solid #dee2e6; background: #fff; padding: 15px; position: relative; cursor: grab; }
    .order-card.cod { border-color: #ffc107; background: #fff8e1; }
    .card-border { position: absolute; top: 0; right: 0; width: 5px; height: 100%; background: #5a35ff; border-top-right-radius: .5rem; border-bottom-right-radius: .5rem; }
    .card-border.cod { background: #ffc107; }
    .order-grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
    .order-info i, .order-info a i { margin-left: 5px; }
    .order-number { position: absolute; top: 10px; left: 10px; background: #f8f9fa; color: #343a40; padding: 2px 8px; border-radius: .25rem; font-size: .9rem; }
  </style>
</head>
<body>
  <!-- Audio elements -->
  <audio id="audioSuccess" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="audioFail" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <div class="container">
    <div class="header">
      <h1 class="text-primary">Ù…Ù†Ø¸Ù… Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h1>
      <input id="scannerInput" class="form-control scanner-input" type="text" placeholder="Ø§Ù…Ø³Ø­ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§" />
    </div>
    <div class="row controls">
      <input id="fileInput" class="form-control col-auto" type="file" accept=".xlsx,.xls" />
      <input id="searchInput" class="form-control col-auto" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
      <button id="manualSortBtn" class="btn btn-info btn-sm col-auto">ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ÙŠØ¯ÙˆÙŠ</button>
      <button id="applyNumberBtn" class="btn btn-primary btn-sm col-auto">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ù‚ÙŠÙ…</button>
      <button id="exportBtn" class="btn btn-success btn-sm col-auto">ØªØµØ¯ÙŠØ± Excel</button>
      <button id="resetOrderBtn" class="btn btn-secondary btn-sm col-auto">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
      <button id="clearStorage" class="btn btn-danger btn-sm col-auto">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
    <div class="status-filters">
      <button class="btn btn-outline-dark status-btn active" data-status=""><i class="bi bi-list"></i> Ø§Ù„ÙƒÙ„</button>
      <button class="btn btn-outline-secondary status-btn" data-status="Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"><i class="bi bi-hourglass-split"></i> Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</button>
      <button class="btn btn-outline-warning status-btn" data-status="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„"><i class="bi bi-truck"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„</button>
      <button class="btn btn-outline-success status-btn" data-status="ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„"><i class="bi bi-check-lg"></i> ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</button>
      <button class="btn btn-outline-info status-btn" data-status="Ù…Ø¤Ø¬Ù„"><i class="bi bi-pause-circle"></i> Ù…Ø¤Ø¬Ù„</button>
      <button class="btn btn-outline-danger status-btn" data-status="Ù…Ø±ÙÙˆØ¶"><i class="bi bi-x-circle"></i> Ù…Ø±ÙÙˆØ¶</button>
    </div>
    <div id="ordersContainer" class="order-grid mb-4"></div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    let orders = [], sortable = null, filterStatus = '';

    const cashOnDelivery = 'Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø³ØªÙ„Ø§Ù…';
    const statuses = ['Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±','Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„','ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„','Ù…Ø¤Ø¬Ù„','Ù…Ø±ÙÙˆØ¶'];
    const messages = {
      shipping: `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…\nØ£Ù†Ø§ Ù…Ù†Ø¯ÙˆØ¨ ÙˆØ§Ø­Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©\nÙ„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ÙŠØ© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªÙˆØµÙŠÙ„\nØ£Ø±Ø³Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ğŸ“\nÙˆØ±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„ğŸš\nÙˆØ³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„â³ ğŸš—`,
      arrival: `Ø¯Ù‚ÙŠÙ‚Ø© ØªÙ‚Ø±ÙŠØ¨Ø§ ÙˆØ¨ÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù† Ø´Ø§Ø¡Ø§Ù„Ù„Ù‡\nÙ…Ù†Ø§Ø³Ø¨ØŸØŸ`
    };

    function playSuccess() {
      document.getElementById('audioSuccess').play().catch(()=>{});
    }
    function playFail() {
      document.getElementById('audioFail').play().catch(()=>{});
    }

    function save(){ localStorage.setItem('ordersData', JSON.stringify(orders)); }
    function load(){ const d=localStorage.getItem('ordersData'); if(d){orders=JSON.parse(d);render();}}

    function render(){
      const cont=document.getElementById('ordersContainer'); cont.innerHTML='';
      let list=orders.slice();
      if(filterStatus) list=list.filter(o=>o.status===filterStatus);
      const q=document.getElementById('searchInput').value.trim().toLowerCase();
      if(q) list=list.filter(o=> o['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'].toString().includes(q) || o['Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„'].toLowerCase().includes(q) );
      list.forEach((o,i)=>{
        const num=o.manualOrder||i+1; const tel=o['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„'].replace(/\D/g,''); const cod=o['Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹']===cashOnDelivery;
        const card=document.createElement('div'); card.className='order-card position-relative'+(cod?' cod':''); card.setAttribute('data-id',o['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']);
        card.innerHTML=`
          <span class="order-number">${num}</span>
          <div class="card-border${cod?' cod':''}"></div>
          <div class="d-flex justify-content-between align-items-center mb-2"><strong>#${o['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']}</strong>${cod?`<span class="badge bg-warning text-dark">Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø³ØªÙ„Ø§Ù…: ${o['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨']} Ø±ÙŠØ§Ù„</span>`:''}</div>
          <h5>${o['Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„']}</h5>
          <p class="order-info mb-1"><i class="bi bi-geo-alt-fill text-danger"></i> ${o['Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„']}</p>
          <div class="d-flex mb-2"><a href="tel:${tel}" class="btn btn-outline-primary btn-sm"><i class="bi bi-telephone-fill"></i></a><a href="https://wa.me/${tel}?text=${encodeURIComponent(messages.shipping)}" target="_blank" class="btn btn-success btn-sm btn-wa"><i class="bi bi-whatsapp"></i></a></div>
          <div class="d-flex justify-content-between align-items-center"><select class="form-select form-select-sm status-select" style="width:auto;">${statuses.map(s=>`<option value="${s}" ${s===o.status?'selected':''}>${s}</option>`).join('')}</select><input type="number" class="form-control form-control-sm order-input" style="width:60px;margin-left:10px;" min="1" value="${num}"></div>`;
        card.querySelector('.status-select').addEventListener('change',e=>{o.status=e.target.value;save();render();});
        card.querySelector('.order-input').addEventListener('change',e=>{o.manualOrder=parseInt(e.target.value)||1;save();});
        cont.appendChild(card);
      });
      if(!sortable) initSortable();
    }

    function initSortable(){
      sortable=Sortable.create(document.getElementById('ordersContainer'),{animation:150,disabled:true,onEnd:()=>{
        const ids=Array.from(document.querySelectorAll('.order-card')).map(el=>el.getAttribute('data-id'));
        orders=ids.map(id=>orders.find(o=>o['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'].toString()===id));save();render();
      }});
    }

    // Barcode scanning (using FileReader.readAsBinaryString for Excel)
    const scanner=document.getElementById('scannerInput');
    window.addEventListener('load',()=>scanner.focus());
    scanner.addEventListener('keydown',e=>{
      if(e.key==='Enter'){e.preventDefault();const code=scanner.value.trim();scanner.value='';const ord=orders.find(o=>o['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'].toString()===code);if(ord&&ord.status==='Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'){ord.status='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„';save();render();playSuccess();}else{playFail();alert('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù„ÙŠØ³ ÙÙŠ Ø­Ø§Ù„Ø© "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±".');}}
    });

    document.getElementById('fileInput').addEventListener('change',function(e){
      const f=this.files[0];if(!f)return;const reader=new FileReader();reader.onload=evt=>{try{const wb=XLSX.read(evt.target.result,{type:'binary'});processWorkbook(wb);}catch{alert('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ù€Excel.');}};reader.readAsBinaryString(f);
    });

    function processWorkbook(wb){
      try{const ws=wb.Sheets[wb.SheetNames[0]];orders=XLSX.utils.sheet_to_json(ws,{defval:''}).map(r=>({...r,status:'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',manualOrder:null}));save();render();}catch{alert('ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ù€Excel.');}
    }

    document.getElementById('searchInput').addEventListener('input',render);
    document.querySelectorAll('.status-btn').forEach(btn=>btn.addEventListener('click',()=>{
      document.querySelectorAll('.status-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      filterStatus=btn.getAttribute('data-status');
      render();
    }));

    document.getElementById('manualSortBtn').addEventListener('click',()=>{
      sortable.option('disabled',!sortable.option('disabled'));
      document.getElementById('manualSortBtn').textContent=sortable.option('disabled')?'ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ÙŠØ¯ÙˆÙŠ':'ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ÙŠØ¯ÙˆÙŠ';
    });

    document.getElementById('applyNumberBtn').addEventListener('click',()=>{
      orders.sort((a,b)=>(a.manualOrder||0)-(b.manualOrder||0));
      save();render();
    });

    document.getElementById('exportBtn').addEventListener('click',()=>{
      if(!orders.length)return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
      const data=orders.map(o=>({'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨':o['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'],'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„':o['Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„'],'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„':o['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„'],'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„':o['Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„'],'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹':o['Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹'],'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨':o['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨'],'Ø§Ù„Ø­Ø§Ù„Ø©':o.status,'Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ÙŠØ¯ÙˆÙŠ':o.manualOrder||''}));
      const ws=XLSX.utils.json_to_sheet(data);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Orders');XLSX.writeFile(wb,'Orders_export.xlsx');
    });

    document.getElementById('resetOrderBtn').addEventListener('click',()=>{localStorage.removeItem('ordersData');location.reload();});
    document.getElementById('clearStorage').addEventListener('click',()=>{localStorage.removeItem('ordersData');orders=[];render();});

    window.addEventListener('load',load);
  </script>
</body>
</html>
